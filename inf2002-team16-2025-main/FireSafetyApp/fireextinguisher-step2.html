<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fire Extinguisher Demo</title>
  <link rel="stylesheet" href="static/css/style.css">
  <style>
    .extinguisher-demo-container {
      position: relative;
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      overflow: hidden;
    }

    .fire-extinguisher {
      position: absolute;
      bottom: 20px;
      left: 20px;
      width: 150px;
      z-index: 1;
    }

    .nozzle-container {
      position: absolute;
      bottom: 195px;
      left: 110px;
      width: 0;
      height: 0;
      transform-origin: 0 0;
      z-index: 2;
    }

    .hose-segment {
      position: absolute;
      width: 100%;
      height: 14px;
      background-color: #222;
      border-radius: 7px;
      top: -7px;
    }

    .nozzle {
      position: absolute;
      right: -40px;
      top: -15px;
      width: 55px;
      transform: rotate(180deg);
    }

    .drag-zone {
      position: absolute;
      bottom: 180px;
      left: 100px;
      width: 200px;
      height: 200px;
      cursor: move;
      z-index: 10;
    }

    .fire {
      position: absolute;
      top: 120px;
      left: 140px;
      width: 100px;
      z-index: 0;
    }
    .dustbin{
      position: absolute;
      top: 120px;
      right: 120px;
      width: 150px;
      z-index: 0;
    }

    .success-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255,255,255,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 99;
    }

    .success-stamp {
      width: 200px;
      opacity: 0;
      transform: scale(0.1);
      transition: all 0.4s ease;
    }

    .stamped {
      opacity: 1 !important;
      transform: scale(1) rotate(0deg);
    }
  </style>
</head>
<body>
  <div class="frame">

    <!-- Header -->
    <div data-include="header.html" data-title="Step 2: Aim" data-step="2" data-total="4"></div>

    <!-- Main Content -->
    <div class="container-demo2 extinguisher-demo-container bg-wall">
      <h2 data-speakable id="instruction-text">Aim the nozzle at the fire!</h2>
      <img src="assests/images/equipments/dustbin.png" class="dustbin" alt="dustbin">

      <img id="fire" src="assests/images/equipments/fire.png" class="fire" alt="Fire">


      <img src="assests/images/equipments/fireextinguisher-no-nozzle.png" class="fire-extinguisher" alt="Fire Extinguisher">

      <div id="nozzle-container" class="nozzle-container">
        <div class="hose-segment"></div>
        <img src="assests/images/equipments/fire-nozzle.png" class="nozzle" id="nozzle" alt="Nozzle">
      </div>

      <div id="drag-zone" class="drag-zone"></div>

      <div id="success-overlay" class="success-overlay">
        <img src="assests/images/equipments/complete-stamp.png" class="success-stamp" alt="Success">
      </div>
    </div>

    <div data-include="footer.html"></div>
  </div>

  <script src="static/js/include.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const instructionText = document.getElementById('instruction-text');
      const fire = document.getElementById('fire');
      const nozzleContainer = document.getElementById('nozzle-container');
      const nozzle = document.getElementById('nozzle');   
      const dragZone = document.getElementById('drag-zone');
      const successOverlay = document.getElementById('success-overlay');
      const successStamp = document.querySelector('.success-stamp');
      const frame = document.querySelector('.frame');

      let isDragging = false;
      let origin = { x: 0, y: 0 };
      let frameRect;
      let targetAngle = 180;
      const aimTolerance = 10; // degrees within which we consider the nozzle aimed
      let hasShownSuccess = false;

      function updateOrigin() {
        frameRect = frame.getBoundingClientRect();
        // anchor point near extinguisher mouth
        origin.x = frameRect.left + 170;
        origin.y = frameRect.bottom - 190;
        updateTargetAngle();
      }

      function updateTargetAngle() {
        if (!fire) return;
        const fireRect = fire.getBoundingClientRect();
        const fireCenterX = fireRect.left + fireRect.width / 2;
        const fireCenterY = fireRect.top + fireRect.height / 2;
        targetAngle = Math.atan2(fireCenterY - origin.y, fireCenterX - origin.x) * (180 / Math.PI);
      }

      function angleDelta(a, b) {
        const diff = Math.abs(((a - b) % 360) + 360) % 360;
        return diff > 180 ? 360 - diff : diff;
      }

      // Initialize immediately
      nozzleContainer.classList.remove('hidden');
      instructionText.textContent = "Aim the nozzle at the fire!";
      updateOrigin();
      window.addEventListener('resize', updateOrigin);

      const startDrag = (e) => {
        e.preventDefault();
        isDragging = true;
        nozzle.style.visibility = 'hidden';
        document.addEventListener('mousemove', handleDrag);
        document.addEventListener('mouseup', endDrag);
        document.addEventListener('touchmove', handleDrag);
        document.addEventListener('touchend', endDrag);
        dragZone.style.cursor = 'grabbing';
      };

      const handleDrag = (e) => {
        if (!isDragging || hasShownSuccess) return;
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        const dx = clientX - origin.x;
        const dy = clientY - origin.y;
        const distance = Math.sqrt(dx * dx + dy * dy);
        const angle = Math.atan2(dy, dx) * (180 / Math.PI);

        nozzleContainer.style.width = `${distance}px`;
        nozzleContainer.style.transform = `rotate(${angle}deg)`;

        if (angleDelta(angle, targetAngle) <= aimTolerance && distance > 60) {
          showSuccess();
        }
      };

const endDrag = () => {
  isDragging = false;

  // Smoothly retract the hose
  nozzleContainer.style.transition = 'width 0.4s ease';
  nozzleContainer.style.width = '0';

  // Make nozzle visible again at original position
  setTimeout(() => {
    nozzle.style.visibility = 'visible';
    nozzleContainer.style.transition = ''; // reset transition
  }, 400);

  // Remove listeners
  document.removeEventListener('mousemove', handleDrag);
  document.removeEventListener('mouseup', endDrag);
  document.removeEventListener('touchmove', handleDrag);
  document.removeEventListener('touchend', endDrag);
  dragZone.style.cursor = 'grab';
};

      function showSuccess() {
        if (hasShownSuccess) return;
        hasShownSuccess = true;
        instructionText.classList.add('hidden-opacity');
        successOverlay.style.display = 'flex';
        setTimeout(() => successStamp.classList.add('stamped'), 100);
        setTimeout(() => {
          window.location.href = 'fireextinguisher-demo3.html';
        }, 3000);
      }

      dragZone.addEventListener('mousedown', startDrag);
      dragZone.addEventListener('touchstart', startDrag);
    });
  </script>
</body>
</html>