<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fire Extinguisher Demo</title>
  <link rel="stylesheet" href="static/css/style.css">
  <style>
    .extinguisher-demo-container {
      position: relative;
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      overflow: hidden;
      background-color: #f4f4f4;
    }

    .fire-extinguisher {
      position: absolute;
      bottom: 20px;
      left: 20px;
      width: 150px;
      z-index: 1;
    }

    .nozzle-container {
      position: absolute;
      bottom: 195px;
      left: 110px;
      width: 0;
      height: 0;
      transform-origin: 0 0;
      z-index: 2;
    }

    .hose-segment {
      position: absolute;
      width: 100%;
      height: 14px;
      background-color: #222;
      border-radius: 7px;
      top: -7px;
    }

    .nozzle {
      position: absolute;
      right: -40px;
      top: -15px;
      width: 55px;
      transform: rotate(180deg);
    }

    .drag-zone {
      position: absolute;
      bottom: 180px;
      left: 100px;
      width: 200px;
      height: 200px;
      cursor: move;
      z-index: 10;
    }

    .spray-wrapper {
      position: absolute;
      top: -40px;
      left: 100%;
      transform-origin: left center;
      transform: rotate(0deg);
      z-index: 1;
      pointer-events: none;
    }

    .spray {
      position: relative;
      width: 0;
      height: 0;
      border-top: 40px solid transparent;
      border-bottom: 40px solid transparent;
      border-right: 150px solid rgba(161, 156, 156, 0.8); /* tip sits at the nozzle anchor */
      filter: blur(4px);
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .spray.active {
      opacity: 1;
      animation: sprayPulse 0.3s infinite alternate;
    }

    @keyframes sprayPulse {
      0% { transform: scaleX(1) scaleY(1); opacity: 0.7; }
      100% { transform: scaleX(1.1) scaleY(1.05); opacity: 1; }
    }

    .fire {
      position: absolute;
      top: 120px;
      left: 140px;
      width: 100px;
      z-index: 0;
      transform-origin: center center;
      transition: transform 0.4s ease;
    }
    .fire.extinguished {
      transform: scale(0.55);
    }
    .dustbin{
      position: absolute;
      top: 120px;
      right: 120px;
      width: 150px;
      z-index: 0;
    }

    .success-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(255,255,255,0.8);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 99;
    }

    .success-stamp {
      width: 200px;
      opacity: 0;
      transform: scale(0.1);
      transition: all 0.4s ease;
    }

    .stamped {
      opacity: 1 !important;
      transform: scale(1) rotate(0deg);
    }
  </style>
</head>
<body>
  <div class="frame">

    <!-- Header -->
    <div data-include="header.html" data-title="Step 4: Sweep"></div>

    <!-- Main Content -->
    <div class="container-demo2 extinguisher-demo-container bg-wall">
      <h2 data-speakable id="instruction-text">Pull out the nozzle and spray toward the fire</h2>

      <img src="assests/images/equipments/dustbin.png" class="dustbin" alt="dustbin">
      <img id="fire" src="assests/images/equipments/fire.png" class="fire" alt="Fire">
      <img src="assests/images/equipments/fireextinguisher-no-nozzle.png" class="fire-extinguisher" alt="Fire Extinguisher">

      <div id="nozzle-container" class="nozzle-container">
        <div class="hose-segment"></div>
        <img src="assests/images/equipments/fire-nozzle.png" class="nozzle" id="nozzle" alt="Nozzle">

        <div id="spray-wrapper" class="spray-wrapper">
          <div id="spray" class="spray"></div>
        </div>
      </div>

      <div id="drag-zone" class="drag-zone"></div>

      <div id="success-overlay" class="success-overlay">
        <img src="assests/images/equipments/complete-stamp.png" class="success-stamp" alt="Success">
      </div>
    </div>

    <div data-include="footer.html"></div>
  </div>

  <script src="static/js/include.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const instructionText = document.getElementById('instruction-text');
      const fire = document.getElementById('fire');
      const nozzleContainer = document.getElementById('nozzle-container');
      const nozzle = document.getElementById('nozzle');   
      const dragZone = document.getElementById('drag-zone');
      const sprayWrapper = document.getElementById('spray-wrapper');
      const spray = document.getElementById('spray');
      const successOverlay = document.getElementById('success-overlay');
      const successStamp = document.querySelector('.success-stamp');
      const frame = document.querySelector('.frame');

      let isDragging = false;
      let origin = { x: 0, y: 0 };
      let targetAngle = 180;
      let holdTimer = null;
      let shrinkTimer = null;
      let hasCompleted = false;
      let fireShrunk = false;
      const aimTolerance = 15; // more forgiving aiming tolerance
      const minDistance = 60; // require some extension before counting aim
      const maxDistance = 100; // cap how far the hose can extend

      function updateOrigin() {
        const frameRect = frame.getBoundingClientRect();
        origin.x = frameRect.left + 170;
        origin.y = frameRect.bottom - 190;
        updateTargetAngle();
      }

      function updateTargetAngle() {
        if (!fire) return;
        const fireRect = fire.getBoundingClientRect();
        const fireCenterX = fireRect.left + fireRect.width / 2;
        const fireCenterY = fireRect.top + fireRect.height / 2;
        targetAngle = normalizeAngle(Math.atan2(fireCenterY - origin.y, fireCenterX - origin.x) * (180 / Math.PI) + 30);
        setSprayAngle(targetAngle);
      }

      function angleDelta(a, b) {
        return Math.abs(((a - b + 180) % 360 + 360) % 360 - 180);
      }

      function normalizeAngle(deg) {
        return ((deg % 360) + 360) % 360;
      }

      function setSprayAngle() {
        // Keep mist aligned with the nozzle; nozzle rotation already follows the cursor
        sprayWrapper.style.transform = 'rotate(0deg)';
      }

      // Initialize immediately
      nozzleContainer.classList.remove('hidden');
      instructionText.textContent = "Pull out the nozzle and spray toward the fire";
      updateOrigin();
      window.addEventListener('resize', () => {
        updateOrigin();
        // Keep hose visually pointed toward the target after resize
        nozzleContainer.style.transform = `rotate(${targetAngle}deg)`;
      });

      const startDrag = (e) => {
        e.preventDefault();
        isDragging = true;
        nozzle.style.visibility = 'hidden';
        spray.classList.add('active');
        document.addEventListener('mousemove', handleDrag);
        document.addEventListener('mouseup', endDrag);
        document.addEventListener('touchmove', handleDrag);
        document.addEventListener('touchend', endDrag);
        dragZone.style.cursor = 'grabbing';
      };

      const handleDrag = (e) => {
        if (!isDragging || hasCompleted) return;
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        const dx = clientX - origin.x;
        const dy = clientY - origin.y;
        const distance = Math.sqrt(dx * dx + dy * dy);
        const clampedDistance = Math.min(distance, maxDistance);
        const angle = normalizeAngle(Math.atan2(dy, dx) * (180 / Math.PI) + 30);
        const tipPosition = {
          x: origin.x + clampedDistance * Math.cos(angle * (Math.PI / 180)),
          y: origin.y + clampedDistance * Math.sin(angle * (Math.PI / 180)),
        };

        nozzleContainer.style.width = `${clampedDistance}px`;
        nozzleContainer.style.transform = `rotate(${angle}deg)`;
        setSprayAngle(angle);

        const aimedAtFire = angleDelta(angle, targetAngle) <= aimTolerance;
        const overFire = isTipOverFire(tipPosition);

        if ((aimedAtFire || overFire) && clampedDistance > minDistance) {
          startShrinkCountdown();
        } else {
          clearShrinkCountdown();
        }
      };

const endDrag = () => {
  if (!isDragging) return;
  isDragging = false;
  spray.classList.remove('active');
  clearTimeout(holdTimer);
  clearShrinkCountdown();

  nozzleContainer.style.transition = 'width 0.4s ease';
  nozzleContainer.style.width = '0';

  setTimeout(() => {
    nozzle.style.visibility = 'visible';
    nozzleContainer.style.transition = '';
    nozzleContainer.style.transform = `rotate(${targetAngle}deg)`;
    setSprayAngle(targetAngle);
  }, 400);

  document.removeEventListener('mousemove', handleDrag);
  document.removeEventListener('mouseup', endDrag);
  document.removeEventListener('touchmove', handleDrag);
  document.removeEventListener('touchend', endDrag);
  dragZone.style.cursor = 'grab';
};

      function startShrinkCountdown() {
        if (fireShrunk || shrinkTimer) return;
        clearTimeout(shrinkTimer);
        shrinkTimer = setTimeout(() => {
          shrinkFire();
        }, 1000);
      }

      function clearShrinkCountdown() {
        clearTimeout(shrinkTimer);
        shrinkTimer = null;
      }

      function shrinkFire() {
        if (!fire || fireShrunk) return;
        fire.classList.add('extinguished');
        fireShrunk = true;
        clearShrinkCountdown();
        // After fire is reduced, wait 2s then mark completion
        clearTimeout(holdTimer);
        holdTimer = setTimeout(() => {
          completeTask();
        }, 2000);
      }

      function isTipOverFire(tip) {
        if (!fire) return false;
        const rect = fire.getBoundingClientRect();
        return tip.x >= rect.left && tip.x <= rect.right && tip.y >= rect.top && tip.y <= rect.bottom;
      }

      function completeTask() {
        if (hasCompleted) return;
        hasCompleted = true;
        spray.classList.remove('active');

        successOverlay.style.display = 'flex';
        setTimeout(() => successStamp.classList.add('stamped'), 100);
        setTimeout(() => {
          window.location.href = 'fireextinguisher-end.html';
        }, 3000);
      }

      dragZone.addEventListener('mousedown', startDrag);
      dragZone.addEventListener('touchstart', startDrag);
    });
  </script>
</body>
</html>
